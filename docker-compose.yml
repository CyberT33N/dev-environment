networks:
  default:
    name: localdev
    external: true

volumes:
  # Docker-managed volume for MSSQL (works reliably on Windows/WSL2 + Linux)
  mssql-data:

services:
  # One-shot init container to fix permissions on the MSSQL volume for SQL Server 2022 non-root.
  # SQL Server runs as user `mssql` (UID 10001), so the data directory must be writable by 10001.
  mssql-init:
    image: alpine:3.19
    container_name: mssql-dev-init
    user: "0:0"
    command:
      - sh
      - -c
      - >
        mkdir -p /var/opt/mssql/data /var/opt/mssql/log /var/opt/mssql/secrets &&
        chown -R 10001:0 /var/opt/mssql &&
        chmod -R g=u /var/opt/mssql
    volumes:
      - mssql-data:/var/opt/mssql
    restart: "no"

  # One-shot post-start config for SQL Server memory tuning.
  # Why: Under heavy imports SQL Server can trigger memory pressure (Error 701) and close TCP connections.
  # This container runs once after MSSQL becomes healthy and sets `max server memory (MB)`.
  #
  # Reference: https://hub.docker.com/r/microsoft/mssql-server
  mssql-config:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: mssql-dev-config
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      MSSQL_SA_PASSWORD: "Test1234!"
      # Default is intentionally moderate (safe-by-default for dev machines).
      # Override by setting MSSQL_MAX_SERVER_MEMORY_MB (e.g. in your shell env or a .env file).
      MSSQL_MAX_SERVER_MEMORY_MB: "${MSSQL_MAX_SERVER_MEMORY_MB:-6144}"
      # Import-friendly defaults (optional overrides)
      MSSQL_MAXDOP: "${MSSQL_MAXDOP:-4}"
      MSSQL_COST_THRESHOLD_FOR_PARALLELISM: "${MSSQL_COST_THRESHOLD_FOR_PARALLELISM:-50}"
    entrypoint:
      - /bin/bash
      - -lc
    command:
      - >
        /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P "$${MSSQL_SA_PASSWORD}" -No -Q
        "EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
         EXEC sp_configure 'max server memory (MB)', $${MSSQL_MAX_SERVER_MEMORY_MB}; RECONFIGURE;
         EXEC sp_configure 'optimize for ad hoc workloads', 1; RECONFIGURE;
         EXEC sp_configure 'max degree of parallelism', $${MSSQL_MAXDOP}; RECONFIGURE;
         EXEC sp_configure 'cost threshold for parallelism', $${MSSQL_COST_THRESHOLD_FOR_PARALLELISM}; RECONFIGURE;
         DBCC FREESYSTEMCACHE('SQL Plans');
         DBCC FREEPROCCACHE;"
    restart: "no"

  mongo:
    extends:
      file: services/mongo/service.yml
      service: mongo
      
  gitlab:
    extends:
      file: services/gitlab/service.yml
      service: gitlab

  gitlab-runner:
    depends_on:
      - gitlab
    extends:
      file: services/gitlab-runner/service.yml
      service: gitlab-runner

  postgres:
    extends:
      file: services/postgres/service.yml
      service: postgres

  firebird:
    extends:
      file: services/firebird/service.yml
      service: firebird

  mssql:
    depends_on:
      mssql-init:
        condition: service_completed_successfully
    extends:
      file: services/mssql/service.yml
      service: mssql
    # Override volume strategy to ensure we *only* use the Docker-managed volume.
    volumes:
      - mssql-data:/var/opt/mssql
    # Memory settings (defaults are intentionally moderate / safe-by-default for dev machines).
    # Override by setting MSSQL_MEM_LIMIT / MSSQL_MEM_RESERVATION (e.g. in your shell env or a .env file).
    mem_limit: ${MSSQL_MEM_LIMIT:-8g}
    mem_reservation: ${MSSQL_MEM_RESERVATION:-4g}

